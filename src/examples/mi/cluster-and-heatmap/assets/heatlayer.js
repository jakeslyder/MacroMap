dojo.provide("modules.HeatLayer"),dojo.addOnLoad(function(){dojo.declare("modules.HeatLayer",esri.layers.Layer,{"-chains-":{constructor:"manual"},constructor:function(a,b){this.inherited(arguments,["http://some.server.com/path",b]);var c=b.id||"HeatMapLayer"+Math.ceil(Math.random(100)*100);this.id=c,this.data=a,this.pxgrid=b.pixelsSquare||128,this.pattern=[{start:2,red:function(a){return 200},green:function(a){return 200},blue:function(a){return 200},alpha:function(a){return Math.max(40,a)}},{start:51,red:function(a){return 151},green:function(a){return 150},blue:function(a){return 155},alpha:function(a){return a}},{start:102,red:function(a){return 117},green:function(a){return 114},blue:function(a){return 111},alpha:function(a){return a}},{start:153,red:function(a){return 97},green:function(a){return 97},blue:function(a){return 98},alpha:function(a){return a}},{start:204,red:function(a){return 40},green:function(a){return 40},blue:function(a){return 49},alpha:function(a){return a}}],this.loaded=!0,this.onLoad(this)},_setMap:function(a,b){this._map=a;var c;if(dojo.isIE&&dojo.isIE<=8){var c=document.createElement("canvas");b.appendChild(c),c=G_vmlCanvasManager.initElement(c),c.setAttribute("width",a.width),c.setAttribute("height",a.height),c.setAttribute("position","absolute"),c.setAttribute("left","0px"),c.setAttribute("top","0px")}else c=this._element=dojo.create("canvas",{width:a.width+"px",height:a.height+"px",style:"position: absolute; left: 0px; top: 0px;"},b);return this._element=c,esri._isDefined(this.opacity)&&dojo.style(c,"opacity",this.opacity),esri._isDefined(this.globalMax)||(this.globalMax=!0),esri._isDefined(this.dotRadius)||(this.dotRadius=50),this._context=c.getContext("2d"),this._context||console.error("This browser does not support <canvas> elements."),this._mapWidth=a.width,this._mapHeight=a.height,this._connects=[],this._connects.push(dojo.connect(a,"onPan",this,this._panHandler)),this._connects.push(dojo.connect(a,"onExtentChange",this,this._extentChangeHandler)),this._connects.push(dojo.connect(a,"onZoomStart",this,this.clear)),this._connects.push(dojo.connect(this,"onVisibilityChange",this,this._visibilityChangeHandler)),this._connects.push(dojo.connect(this,"onOpacityChange",this,this._opacityChangeHandler)),this._connects.push(dojo.connect(this._map,"onZoomEnd",this,this.regrid)),this._drawHeatData(),c},_unsetMap:function(a,b){dojo.forEach(this._connects,dojo.disconnect,dojo),this._element&&b.removeChild(this._element),this._map=this._element=this._context=this.data=this._connects=null},setOpacity:function(a){this.opacity!=a&&this.onOpacityChange(this.opacity=a)},onOpacityChange:function(){},regrid:function(){this.setData(this.lastDataset)},setData:function(a){this.lastDataset=a;var b={},c=dojo.coords(this._map.id).w*1/(this.pxgrid*1),d=(this._map.extent.xmax-this._map.extent.xmin)/c;b.gridsquare=d,dojo.forEach(a,function(a){var c=Math.round(a.y/d)+"|"+Math.round(a.x/d);b[c]?(b[c].count+=1,b[c].avgx+=(a.x-b[c].avgx)/b[c].count,b[c].avgy+=(a.y-b[c].avgy)/b[c].count):b[c]={count:1,avgx:a.x,avgy:a.y}}),this.data={data:b,noDataValue:[0]},b={},this.refresh()},refresh:function(){if(!this._canDraw())return;this._drawHeatData()},clear:function(){if(!this._canDraw())return;this._context.clearRect(0,0,this._mapWidth,this._mapHeight)},getColorValues:function(){var a=[],b=[.01,.25,.5,.75,1];return dojo.forEach(b,dojo.hitch(this,function(b){for(var c=0;c<this.pattern.length;c++)if(c==this.pattern.length-1||this.pattern[c+1].start>=b*255){var d=Math.floor(this.pattern[c].red(b*255)),e=Math.floor(this.pattern[c].green(b*255)),f=Math.floor(this.pattern[c].blue(b*255)),g=this.pattern[c].alpha(b*255)*this.opacity/255;a.push("rgba("+d+","+e+","+f+","+g+")");return}})),a},getRange:function(){var a=this.data;if(!a)return;var b=a.data,c=a.noDataValue[0],d=0,e=0;for(var f in b)if(b.hasOwnProperty(f)){var g=b[f].count;if(g==c)continue;g>d&&(d=g),g<e&&(e=g)}return{min:e,max:d}},getDatasetRange:function(){var a=this.data;if(!a)return;var b=a.rasterProperties;if(b)return{min:b.datasetMin,max:b.datasetMax}},_canDraw:function(){return this._map&&this._element&&this._context?!0:!1},_panHandler:function(a,b){dojo.style(this._element,{left:b.x+"px",top:b.y+"px"})},_extentChangeHandler:function(a,b,c,d){c||(dojo.style(this._element,{left:"0px",top:"0px"}),this.clear()),this._drawHeatData()},_drawHeatData:function(){this.clear();if(!this.data)return;var a=this.data,b=a.noDataValue[0],c=a.data,d=this.getRange(),e=d.min,f=d.max;if(e==f&&f==0)return;var g=this._map,h=f>0?this._getCFForPositiveValues(e,f):null,i=e<0?this._getCFForNegativeValues(e,f):null,j=function(a){return a>=0?h(a):i(a)},k=this._context;if(!dojo.isIE||dojo.isIE>8){for(var l in c){if(l=="gridsquare")continue;if(c.hasOwnProperty(l)){var m=this._map.toScreen(new esri.geometry.Point(c[l].avgx,c[l].avgy,g.spatialReference));if(!m)continue;var n=m.x,o=m.y;value=c[l].count;var p;value/d.max>.3?(p=k.createRadialGradient(n,o,Math.round(this.dotRadius/8,0),n,o,this.dotRadius),p.addColorStop(.1,"rgba(0,0,0,"+value/d.max+")"),p.addColorStop(.7,"rgba(0,0,0,"+value/d.max/2+")"),p.addColorStop(1,"rgba(0,0,0,0)")):(p=k.createRadialGradient(n,o,Math.round(this.dotRadius/8,0),n,o,Math.round(this.dotRadius/1.5,0)),p.addColorStop(.1,"rgba(0,0,0,"+2*value/d.max+")"),p.addColorStop(.7,"rgba(0,0,0,"+1.5*value/d.max+")"),p.addColorStop(1,"rgba(0,0,0,0)")),k.fillStyle=p,k.fillRect(n-this.dotRadius,o-this.dotRadius,2*this.dotRadius,2*this.dotRadius)}}var q=k.getImageData(0,0,this._element.width,this._element.height),r=q.data;for(var s=0;s<r.length;s+=4){if(r[s+3]==0)continue;for(var t=0;t<this.pattern.length;t++)if(t==this.pattern.length-1||this.pattern[t+1].start>=r[s+3]){r[s]=this.pattern[t].red(r[s+3]),r[s+1]=this.pattern[t].green(r[s+3]),r[s+2]=this.pattern[t].blue(r[s+3]),r[s+3]=this.pattern[t].alpha(r[s+3]);break}}q.data=r,k.putImageData(q,0,0)}else for(var l in c)if(c.hasOwnProperty(l)){if(l=="gridsquare")continue;var m=this._map.toScreen(new esri.geometry.Point(c[l].avgx,c[l].avgy,g.spatialReference));if(!m)continue;var n=m.x,o=m.y;value=c[l].count;var p;value/d.max>.3?(p=k.createRadialGradient(n,o,Math.round(this.dotRadius/4,0),n,o,this.dotRadius),p.addColorStop(.1,"rgba(255,200,210,"+value/d.max+")"),p.addColorStop(.7,"rgba(255,0,0,"+value/d.max/2+")"),p.addColorStop(1,"rgba(160,0,0,0)")):(p=k.createRadialGradient(n,o,Math.round(this.dotRadius/8,0),n,o,Math.round(this.dotRadius/6,0)),p.addColorStop(.1,"rgba(255,200,210,"+2*value/d.max+")"),p.addColorStop(.7,"rgba(255,0,0,"+1.5*value/d.max+")"),p.addColorStop(1,"rgba(160,0,0,0)")),k.fillStyle=p,k.fillRect(n-this.dotRadius,o-this.dotRadius,2*this.dotRadius,2*this.dotRadius)}c=null},setHeatColors:function(a){this.pattern=a},_getCFForPositiveValues:function(a,b){a<0&&(a=0);var c=255/(b-a);return function(b){return"rgb("+Math.floor((b-a)*c)+", 0, 0)"}},_getCFForNegativeValues:function(a,b){b>0&&(b=0);var c=255/(b-a);return function(b){return"rgb(0, 0, "+Math.floor((b-a)*c)+")"}},_visibilityChangeHandler:function(a){a?esri.show(this._element):esri.hide(this._element)},_opacityChangeHandler:function(a){dojo.style(this._element,"opacity",a)}})}),dojo.declare("modules.RasterRenderer",null,{getColor:function(a){}}),dojo.declare("modules.MyRasterRenderer",modules.RasterRenderer,{constructor:function(a){},getColor:function(a){}});