<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9, IE=10" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
    <title>Cluster</title>

    <link rel="stylesheet" href="http://js.arcgis.com/3.7/js/dojo/dijit/themes/tundra/tundra.css" />
    <link rel="stylesheet" href="http://js.arcgis.com/3.7/js/esri/css/esri.css" />
    <!-- font -->
    <link href="http://fonts.googleapis.com/css?family=Titillium+Web:100,100italic,200,200italic,300,300italic,400,400italic,600,600italic,700,700italic,800,800italic" rel="stylesheet" type="text/css" />

    <link rel="stylesheet" type="text/css" href="../../../css/mapStyles.css"/>
    <link rel="stylesheet" href="../../../css/detailInfo.css" />
    <!-- jQuery -->
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.css" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

    <script>
      // helpful for understanding dojoConfig.packages vs. dojoConfig.paths:
      // http://www.sitepen.com/blog/2013/06/20/dojo-faq-what-is-the-difference-packages-vs-paths-vs-aliases/
      var dojoConfig = { 
        paths: {
          extras: location.pathname.replace(/\/[^/]+$/, "") + "/extras"
        }
      };
    </script>
    <script src="http://js.arcgis.com/3.7/"></script>
    <script>
      var map;
      require([
        "dojo/parser", 
        "dojo/ready",
        "dojo/_base/array",
        "dojo/_base/Color",
        "dojo/dom-style",
        "dojo/query",

        "esri/map", 
        "esri/request",
        "esri/graphic",
        "esri/geometry/Extent",

        "esri/symbols/SimpleMarkerSymbol",
        "esri/symbols/SimpleFillSymbol",
        "esri/symbols/PictureMarkerSymbol",
        "esri/renderers/ClassBreaksRenderer",

        "esri/layers/GraphicsLayer",
        "esri/SpatialReference",
        "esri/geometry/Point",
        "esri/geometry/webMercatorUtils",

        "esri/dijit/PopupTemplate",
        "extras/DetailInfo",
        "extras/ClusterLayer",
        "esri/tasks/query", 
        "esri/tasks/QueryTask",

        "dijit/layout/BorderContainer", 
        "dijit/layout/ContentPane", 
        "dojo/domReady!"
      ], function(
        parser, ready, arrayUtils, Color, domStyle, query,
        Map, esriRequest, Graphic, Extent,
        SimpleMarkerSymbol, SimpleFillSymbol, PictureMarkerSymbol, ClassBreaksRenderer,
        GraphicsLayer, SpatialReference, Point, webMercatorUtils,
        PopupTemplate, DetailInfo, ClusterLayer, Query, QueryTask
      ) {
        ready(function() {
          parser.parse();

          var clusterLayer;
          var detailInfo;
          var popupOptions = {
            "markerSymbol": new SimpleMarkerSymbol("circle", 20, null, new Color([0, 0, 0, 0.25])),
            "marginLeft": "20",
            "marginTop": "20"
          };
          map = new Map("map", {
            basemap: "national-geographic",
            center: [-77.5, 41],
            zoom: 8,
            slider: true,
            sliderPosition: "top-left",
            sliderStyle: 'large'
          });

          map.on("load", function() {
            // hide the popup's ZoomTo link as it doesn't make sense for cluster features
            domStyle.set(query("a.action.zoomTo")[0], "display", "none");

            // get the latest sites from http://services2.arcgis.com/Hq6thdRH56GlK76e/ArcGIS/rest/services/MacroinvertebrateWaterMonitoring_Test/FeatureServer/0
            var sites = esriRequest({
              "url": "data/sites.json",
              "handleAs": "json"
            });
            sites.then(addClusters, error);
          });

          function addClusters(resp) {
            var siteInfo = {};
            var wgs = new SpatialReference({
              "wkid": 3857
            });
            siteInfo.data = arrayUtils.map(resp, function(p) {
              var latlng = new  Point(parseFloat(p.attributes.Lon), parseFloat(p.attributes.Lat), wgs);
              var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
              var attributes = {
                "Caption": p.attributes.OrgID,
                "Name": p.attributes.SiteName,
                "ObjectID": p.attributes.OBJECTID
              };
              return {
                "x": webMercator.x,
                "y": webMercator.y,
                "attributes": attributes
              };
            });

            // Query fields for secondary query for dates
            var queryTask = new QueryTask("http://services2.arcgis.com/Hq6thdRH56GlK76e/ArcGIS/rest/services/MacroinvertebrateWaterMonitoring_Test/FeatureServer/3");

            var query = new Query();
            //query.outFields = ["SurveyDate"];//SiteStatus","OBJECTID","OrgID","SiteID","SiteName","Lat","Lon"];
            query.returnGeometry = false;

            detailInfo = new DetailInfo({
              "queryTask": queryTask,
              "query": query
            });

            // popupTemplate to work with attributes specific to this dataset
            // var popupTemplate = PopupTemplate({
            //   "title": "",
            //   "fieldInfos": [{
            //     "fieldName": "Caption",
            //     visible: true
            //   }, {
            //     "fieldName": "Name",
            //     "label": "By",
            //     visible: true
            //   }, {
            //     "fieldName": "Link",
            //     "label": "On Instagram",
            //     visible: true
            //   }],
            //   "mediaInfos": [{
            //     "title": "",
            //     "caption": "",
            //     "type": "image",
            //     "value": {
            //       "sourceURL": "{Image}",
            //       "linkURL": "{Link}"
            //     }
            //   }]
            // });

            // cluster layer that uses OpenLayers style clustering
            clusterLayer = new ClusterLayer({
              "data": siteInfo.data,
              "distance": 100,
              "id": "clusters",
              "labelColor": "#fff",
              "labelOffset": 10,
              "resolution": map.extent.getWidth() / map.width,
              "singleColor": "#888",
              //"singleTemplate": popupTemplate
              "detailInfo": detailInfo
            });

            var defaultSym = new SimpleMarkerSymbol().setSize(4);
            var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");

            var picBaseUrl = "../../../img/";
            var one = new PictureMarkerSymbol(picBaseUrl + "neon-yellow-wr.png", 15, 15).setOffset(0, 15);
            var smallest = new PictureMarkerSymbol(picBaseUrl + "light-blue-wr.png", 35, 35).setOffset(0, 15);
            var middle = new PictureMarkerSymbol(picBaseUrl + "blue-wr.png", 40, 40).setOffset(0, 15);
            var big = new PictureMarkerSymbol(picBaseUrl + "dark-blue-wr.png", 50, 50).setOffset(0, 15);
            var biggest = new PictureMarkerSymbol(picBaseUrl + "gray.png", 50, 50).setOffset(0, 15);
            renderer.addBreak(0, 2, one);
            renderer.addBreak(2, 20, smallest);
            renderer.addBreak(20, 201, middle);
            renderer.addBreak(201, 1000, big);
            renderer.addBreak(1001, 7000, biggest);

            clusterLayer.setRenderer(renderer);
            map.addLayer(clusterLayer);

            // close the info window when the map is clicked
            map.on("click", cleanUp);
            // TODO add cleanup for zoom
            // close the info window when esc is pressed
            map.on("key-down", function(e) {
              if (e.keyCode === 27) {
                cleanUp();
              }
            });
          }

          getDetailData = function(objectId) {
            detailInfo.getDetailData();
          }

          function cleanUp() {
            map.infoWindow.hide();
            clusterLayer.clearSingles();
          }

          function error(err) {
            console.log("something failed: ", err);
          }

          // show cluster extents...
          // never called directly but useful from the console 
          window.showExtents = function() {
            var extents = map.getLayer("clusterExtents");
            if ( extents ) {
              map.removeLayer(extents);
            }
            extents = new GraphicsLayer({ id: "clusterExtents" });
            var sym = new SimpleFillSymbol().setColor(new Color([205, 193, 197, 0.5]));

            arrayUtils.forEach(clusterLayer._clusters, function(c, idx) {
              var e = c.attributes.extent;
              extents.add(new Graphic(new Extent(e[0], e[1], e[2], e[3], map.spatialReference), sym));
            }, this);
            map.addLayer(extents, 0);
          }
        });

      });

    </script>
  </head>

  <body class="tundra">

      <div id="logo" title="Carnegie Museums of Natural History">
        <a href="http://www.carnegiemnh.org/" target="_blank">
          <img src="../../../img/CMNHLogo@2x.png" alt="Carnegie Museums of Natural History" height="78" width="78">
        </a>
      </div>
      
      <div id="header">
        <p id="site-title">Macroinvertebrate Water Monitoring Map</p>
        <p id="site-subtitle">Exploring the biological health of streams</p>
      </div> <!-- header -->

      <div id="map" ></div>

      <div id="copyright">&copy; 2013 Carnegie Institute</div>

      <div id="dialog" title="Collection Sites">
          <div id="accordion" class="addContent">
            <p>Sites in Cluster</p><div class="cluster-info"></div>
            <p>Macroinvertebrates</p><div class="date"></div>
            <p>Site Info</p><div class="site-info"></div>
          </div>
      </div>

  </body>

</html>

